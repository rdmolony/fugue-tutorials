
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>COVID19 Data Exploration with FugueSQL &#8212; Fugue Tutorials</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet" />
  <link href="../../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/togglebutton.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Applications" href="../applications/index.html" />
    <link rel="prev" title="Stock Sentiment Analysis (Preprocessing)" href="stock_sentiment.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../_static/logo_blue.svg" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Fugue Tutorials</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../index.html">
   Welcome to the Fugue Tutorials!
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Tutorials
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../beginner/index.html">
   Getting Started
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../beginner/introduction.html">
     Introduction
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../beginner/decoupling_logic_and_execution.html">
     Decoupling Logic and Execution
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../beginner/interface.html">
     Fugue Interface
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../beginner/joins.html">
     Joins
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../beginner/beginner_extension.html">
     Extensions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../beginner/distributed_compute.html">
     Distributed Compute
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../beginner/beginner_sql.html">
     FugueSQL
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../extensions/index.html">
   Extensions
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../extensions/creator.html">
     Creator
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../extensions/processor.html">
     Processor
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../extensions/outputter.html">
     Outputter
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../extensions/transformer.html">
     Transformer
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../extensions/cotransformer.html">
     CoTransformer
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../extensions/outputtransformer.html">
     Output Transformer (Advanced)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../extensions/outputcotransformer.html">
     Output CoTransformer (Advanced)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../extensions/interfaceless.html">
     Interfaceless
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../fugue_sql/index.html">
   FugueSQL
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../fugue_sql/syntax.html">
     Syntax
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../fugue_sql/operators.html">
     Operators
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../fugue_sql/python.html">
     Using Python
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../fugue_sql/extensions.html">
     Extensions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../fugue_sql/dask.html">
     FugueSQL and Dask-sql
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../advanced/index.html">
   Deep Dive
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../advanced/dag.html">
     Execution Graph (DAG)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../advanced/useful_config.html">
     Fugue Configurations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../advanced/execution_engine.html">
     Execution Engine
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../advanced/validation.html">
     Extension Input Data Validation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../advanced/schema_dataframes.html">
     Data Type, Schema &amp; DataFrames
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../advanced/partition.html">
     Partitioning
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../advanced/checkpoint.html">
     Checkpoint Deep Dive
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../advanced/rpc.html">
     Callbacks From Transformers To Driver
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../advanced/x-like.html">
     X-like Objects
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Applications
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="index.html">
   Examples
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="stock_sentiment.html">
     Stock Sentiment Analysis (Preprocessing)
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     COVID19 Data Exploration with FugueSQL
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../applications/index.html">
   Applications
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
  <label for="toctree-checkbox-6">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../applications/data_validation.html">
     Data Validation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../applications/databricks_connect.html">
     Using databricks-connect
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Further Information
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../resources.html">
   Resources
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../appendix/index.html">
   Appendix
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
  <label for="toctree-checkbox-7">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../appendix/generate_types.html">
     Fugue and PyArrow Types
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../_sources/tutorials/examples/example_covid19.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/fugue-project/tutorials/master?urlpath=tree/tutorials/examples/example_covid19.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#setup-for-notebooks">
   Setup for Notebooks
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#imports">
   Imports
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#initial-exploration">
   Initial Exploration
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#bring-it-to-spark">
   Bring it to Spark!
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#visualize-it">
   Visualize it
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#visualize-with-spark">
   Visualize with Spark
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#productionizing">
   Productionizing
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#summary">
   Summary
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="covid19-data-exploration-with-fuguesql">
<h1>COVID19 Data Exploration with FugueSQL<a class="headerlink" href="#covid19-data-exploration-with-fuguesql" title="Permalink to this headline">¶</a></h1>
<p>This example will demonstrate how to use FugueSQL for exploratory data analysis. Normally, SparkSQL users find that SQL code is a second class citizen surrounded predominantly by Python code. FugueSQL can support a predominantly SQL code base that invokes Python code because Fugue SQL is treated as a first-class API in Fugue.</p>
<p>As we iterate through this problem, focus on how the problem is defined in a scale agnostic way. We’ll show how to prototype on smaller pieces of data, before running on the larger dataset.</p>
<p>This dataset is from <a class="reference external" href="https://www.kaggle.com/sudalairajkumar/novel-corona-virus-2019-dataset">Kaggle Novel Corona Virus 2019 Dataset</a>.</p>
<div class="section" id="setup-for-notebooks">
<h2>Setup for Notebooks<a class="headerlink" href="#setup-for-notebooks" title="Permalink to this headline">¶</a></h2>
<p>Fugue has a <code class="docutils literal notranslate"><span class="pre">setup()</span></code> function for notebooks that registers the <code class="docutils literal notranslate"><span class="pre">%%fsql</span></code> cell <a class="reference external" href="https://ipython.readthedocs.io/en/stable/interactive/magics.html">magic</a>. This lets us use FugueSQL cells in Jupyter notebooks with syntax highlighting (does not work for JupyterLab notebooks yet). The last part of the notebook will show how to move these cells into production using the <code class="docutils literal notranslate"><span class="pre">fsql</span></code> function.</p>
<p>The native Fugue <code class="docutils literal notranslate"><span class="pre">PRINT</span></code> can’t print wide tables nicely in this environment, so we’ll write an extension <code class="docutils literal notranslate"><span class="pre">pprint</span></code> to render the dataframes as pandas dataframes. Understanding the <code class="docutils literal notranslate"><span class="pre">pprint</span></code> function is not so important.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">fugue_notebook</span> <span class="kn">import</span> <span class="n">setup</span>
<span class="n">setup</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
require(["codemirror/lib/codemirror"]);
function set(str) {
    var obj = {}, words = str.split(" ");
    for (var i = 0; i < words.length; ++i) obj[words[i]] = true;
    return obj;
  }
var fugue_keywords = "fill hash rand even presort persist broadcast params process output outtransform rowcount concurrency prepartition zip print title save append parquet csv json single checkpoint weak strong deterministic yield connect sample seed take sub callback dataframe file";
CodeMirror.defineMIME("text/x-fsql", {
    name: "sql",
    keywords: set(fugue_keywords + " add after all alter analyze and anti archive array as asc at between bucket buckets by cache cascade case cast change clear cluster clustered codegen collection column columns comment commit compact compactions compute concatenate cost create cross cube current current_date current_timestamp database databases data dbproperties defined delete delimited deny desc describe dfs directories distinct distribute drop else end escaped except exchange exists explain export extended external false fields fileformat first following for format formatted from full function functions global grant group grouping having if ignore import in index indexes inner inpath inputformat insert intersect interval into is items join keys last lateral lazy left like limit lines list load local location lock locks logical macro map minus msck natural no not null nulls of on optimize option options or order out outer outputformat over overwrite partition partitioned partitions percent preceding principals purge range recordreader recordwriter recover reduce refresh regexp rename repair replace reset restrict revoke right rlike role roles rollback rollup row rows schema schemas select semi separated serde serdeproperties set sets show skewed sort sorted start statistics stored stratify struct table tables tablesample tblproperties temp temporary terminated then to touch transaction transactions transform true truncate unarchive unbounded uncache union unlock unset use using values view when where window with"),
    builtin: set("date datetime tinyint smallint int bigint boolean float double string binary timestamp decimal array map struct uniontype delimited serde sequencefile textfile rcfile inputformat outputformat"),
    atoms: set("false true null"),
    operatorChars: /^[*\/+\-%<>!=~&|^]/,
    dateSQL: set("time"),
    support: set("ODBCdotTable doubleQuote zerolessFloat")
  });

CodeMirror.modeInfo.push( {
            name: "Fugue SQL",
            mime: "text/x-fsql",
            mode: "sql"
          } );

require(['notebook/js/codecell'], function(codecell) {
    codecell.CodeCell.options_default.highlight_modes['magic_text/x-fsql'] = {'reg':[/%%fsql/]} ;
    Jupyter.notebook.events.on('kernel_ready.Kernel', function(){
    Jupyter.notebook.get_cells().map(function(cell){
        if (cell.cell_type == 'code'){ cell.auto_highlight(); } }) ;
    });
  });
</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">fugue</span> <span class="kn">import</span> <span class="n">NativeExecutionEngine</span><span class="p">,</span> <span class="n">DataFrames</span><span class="p">,</span> <span class="n">PandasDataFrame</span><span class="p">,</span> <span class="n">Schema</span><span class="p">,</span> <span class="n">Transformer</span><span class="p">,</span> <span class="n">IterableDataFrame</span><span class="p">,</span> <span class="n">ArrayDataFrame</span>

<span class="k">def</span> <span class="nf">pprint</span><span class="p">(</span><span class="n">dfs</span><span class="p">:</span><span class="n">DataFrames</span><span class="p">,</span> <span class="n">rows</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">dfs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">pdf</span><span class="o">=</span> <span class="n">PandasDataFrame</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">rows</span><span class="p">),</span> <span class="n">df</span><span class="o">.</span><span class="n">schema</span><span class="p">)</span>
        <span class="n">display</span><span class="p">(</span><span class="n">pdf</span><span class="o">.</span><span class="n">native</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="imports">
<h2>Imports<a class="headerlink" href="#imports" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">fugue</span> <span class="kn">import</span> <span class="n">NativeExecutionEngine</span><span class="p">,</span> <span class="n">DataFrames</span><span class="p">,</span> <span class="n">PandasDataFrame</span><span class="p">,</span> <span class="n">Schema</span><span class="p">,</span> <span class="n">Transformer</span><span class="p">,</span> <span class="n">IterableDataFrame</span><span class="p">,</span> <span class="n">ArrayDataFrame</span>
<span class="kn">from</span> <span class="nn">fugue_sql</span> <span class="kn">import</span> <span class="n">FugueSQLWorkflow</span>
<span class="kn">from</span> <span class="nn">fugue_spark</span> <span class="kn">import</span> <span class="n">SparkExecutionEngine</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="initial-exploration">
<h2>Initial Exploration<a class="headerlink" href="#initial-exploration" title="Permalink to this headline">¶</a></h2>
<p>First we’ll explore how to use the <code class="docutils literal notranslate"><span class="pre">%%fsql</span></code> cell magic. We’ll load two files and use <code class="docutils literal notranslate"><span class="pre">pprint</span></code> on them. The following will run on pandas-based <code class="docutils literal notranslate"><span class="pre">NativeExecutionEngine</span></code> because no engine is specified. There are a couple of FugueSQL features to note. First is how the <code class="docutils literal notranslate"><span class="pre">%%fsql</span></code> cell magic turned the cell into a FugueSQL cell. Second, FugueSQL allows variable assignments of the <code class="docutils literal notranslate"><span class="pre">confirmed</span></code> and <code class="docutils literal notranslate"><span class="pre">death</span></code> DataFrames. These are loaded in a pandas DataFrames because of the <code class="docutils literal notranslate"><span class="pre">NativeExecutionEngine</span></code>. Lastly, we used our <code class="docutils literal notranslate"><span class="pre">pprint</span></code> extension which was written in Python alongside out SQL code.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">fsql</span>
confirmed = LOAD CSV &quot;../../data/confirmed.csv&quot;(header=true)
OUTPUT USING pprint(rows=5)
death = LOAD CSV &quot;../../data/death.csv&quot;(header=true)
OUTPUT USING pprint(rows=5)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>UID</th>
      <th>iso2</th>
      <th>iso3</th>
      <th>code3</th>
      <th>FIPS</th>
      <th>Admin2</th>
      <th>Province_State</th>
      <th>Country_Region</th>
      <th>Lat</th>
      <th>Long_</th>
      <th>...</th>
      <th>_6_3_20</th>
      <th>_6_4_20</th>
      <th>_6_5_20</th>
      <th>_6_6_20</th>
      <th>_6_7_20</th>
      <th>_6_8_20</th>
      <th>_6_9_20</th>
      <th>_6_10_20</th>
      <th>_6_11_20</th>
      <th>_6_12_20</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>84001001</td>
      <td>US</td>
      <td>USA</td>
      <td>840</td>
      <td>1001.0</td>
      <td>Autauga</td>
      <td>Alabama</td>
      <td>US</td>
      <td>32.53952745</td>
      <td>-86.64408227</td>
      <td>...</td>
      <td>239</td>
      <td>241</td>
      <td>248</td>
      <td>259</td>
      <td>265</td>
      <td>272</td>
      <td>282</td>
      <td>295</td>
      <td>312</td>
      <td>323</td>
    </tr>
    <tr>
      <th>1</th>
      <td>84001003</td>
      <td>US</td>
      <td>USA</td>
      <td>840</td>
      <td>1003.0</td>
      <td>Baldwin</td>
      <td>Alabama</td>
      <td>US</td>
      <td>30.72774991</td>
      <td>-87.72207058</td>
      <td>...</td>
      <td>292</td>
      <td>293</td>
      <td>296</td>
      <td>304</td>
      <td>313</td>
      <td>320</td>
      <td>325</td>
      <td>331</td>
      <td>343</td>
      <td>353</td>
    </tr>
    <tr>
      <th>2</th>
      <td>84001005</td>
      <td>US</td>
      <td>USA</td>
      <td>840</td>
      <td>1005.0</td>
      <td>Barbour</td>
      <td>Alabama</td>
      <td>US</td>
      <td>31.868263</td>
      <td>-85.3871286</td>
      <td>...</td>
      <td>177</td>
      <td>177</td>
      <td>183</td>
      <td>190</td>
      <td>193</td>
      <td>197</td>
      <td>199</td>
      <td>208</td>
      <td>214</td>
      <td>221</td>
    </tr>
    <tr>
      <th>3</th>
      <td>84001007</td>
      <td>US</td>
      <td>USA</td>
      <td>840</td>
      <td>1007.0</td>
      <td>Bibb</td>
      <td>Alabama</td>
      <td>US</td>
      <td>32.99642064</td>
      <td>-87.12511459999999</td>
      <td>...</td>
      <td>76</td>
      <td>76</td>
      <td>76</td>
      <td>77</td>
      <td>77</td>
      <td>79</td>
      <td>85</td>
      <td>89</td>
      <td>93</td>
      <td>97</td>
    </tr>
    <tr>
      <th>4</th>
      <td>84001009</td>
      <td>US</td>
      <td>USA</td>
      <td>840</td>
      <td>1009.0</td>
      <td>Blount</td>
      <td>Alabama</td>
      <td>US</td>
      <td>33.98210918</td>
      <td>-86.56790593</td>
      <td>...</td>
      <td>63</td>
      <td>63</td>
      <td>64</td>
      <td>70</td>
      <td>72</td>
      <td>73</td>
      <td>75</td>
      <td>79</td>
      <td>87</td>
      <td>95</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 154 columns</p>
</div></div><div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>UID</th>
      <th>iso2</th>
      <th>iso3</th>
      <th>code3</th>
      <th>FIPS</th>
      <th>Admin2</th>
      <th>Province_State</th>
      <th>Country_Region</th>
      <th>Lat</th>
      <th>Long_</th>
      <th>...</th>
      <th>_6_3_20</th>
      <th>_6_4_20</th>
      <th>_6_5_20</th>
      <th>_6_6_20</th>
      <th>_6_7_20</th>
      <th>_6_8_20</th>
      <th>_6_9_20</th>
      <th>_6_10_20</th>
      <th>_6_11_20</th>
      <th>_6_12_20</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>16</td>
      <td>AS</td>
      <td>ASM</td>
      <td>16</td>
      <td>60.0</td>
      <td>None</td>
      <td>American Samoa</td>
      <td>US</td>
      <td>-14.270999999999999</td>
      <td>-170.132</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>316</td>
      <td>GU</td>
      <td>GUM</td>
      <td>316</td>
      <td>66.0</td>
      <td>None</td>
      <td>Guam</td>
      <td>US</td>
      <td>13.4443</td>
      <td>144.7937</td>
      <td>...</td>
      <td>5</td>
      <td>5</td>
      <td>5</td>
      <td>5</td>
      <td>5</td>
      <td>5</td>
      <td>5</td>
      <td>5</td>
      <td>5</td>
      <td>5</td>
    </tr>
    <tr>
      <th>2</th>
      <td>580</td>
      <td>MP</td>
      <td>MNP</td>
      <td>580</td>
      <td>69.0</td>
      <td>None</td>
      <td>Northern Mariana Islands</td>
      <td>US</td>
      <td>15.0979</td>
      <td>145.6739</td>
      <td>...</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
    </tr>
    <tr>
      <th>3</th>
      <td>630</td>
      <td>PR</td>
      <td>PRI</td>
      <td>630</td>
      <td>72.0</td>
      <td>None</td>
      <td>Puerto Rico</td>
      <td>US</td>
      <td>18.2208</td>
      <td>-66.5901</td>
      <td>...</td>
      <td>140</td>
      <td>140</td>
      <td>141</td>
      <td>142</td>
      <td>142</td>
      <td>142</td>
      <td>142</td>
      <td>143</td>
      <td>144</td>
      <td>146</td>
    </tr>
    <tr>
      <th>4</th>
      <td>850</td>
      <td>VI</td>
      <td>VIR</td>
      <td>850</td>
      <td>78.0</td>
      <td>None</td>
      <td>Virgin Islands</td>
      <td>US</td>
      <td>18.3358</td>
      <td>-64.8963</td>
      <td>...</td>
      <td>6</td>
      <td>6</td>
      <td>6</td>
      <td>6</td>
      <td>6</td>
      <td>6</td>
      <td>6</td>
      <td>6</td>
      <td>6</td>
      <td>6</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 155 columns</p>
</div></div></div>
</div>
<p>Both tables are very wide since each date is a column. It’s not straightforward to do data analysis in this format, so will pivot the table so that each date becomes a row. Spark and pandas have their own ways to pivot tables and neither work for the other engine. Thus, we will write a scale agnostic <code class="docutils literal notranslate"><span class="pre">Transformer</span></code> that will reshape the DataFrame for us. Fugue allows <code class="docutils literal notranslate"><span class="pre">transformers</span></code> to be defined with the <code class="docutils literal notranslate"><span class="pre">&#64;transformer</span></code> decorator, but in this case, there are two compelling reasons to use the class interface:</p>
<ul class="simple">
<li><p>The output schema is dependent on parameters and we need to explicitly define schema for Spark.</p></li>
<li><p>For each partition, the data will be reshaped according to the column names. This requires preprocessing that would repeat on each partition of data. We can perform this operation once by doing it in the <code class="docutils literal notranslate"><span class="pre">on_init</span></code> method, which will make it only run once for all the partitions.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Pivot</span><span class="p">(</span><span class="n">Transformer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_output_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">fields</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)]</span>
        <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get_or_throw</span><span class="p">(</span><span class="s2">&quot;col&quot;</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Schema</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;date:datetime,</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">:int&quot;</span>
    
    <span class="k">def</span> <span class="nf">on_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get_or_throw</span><span class="p">(</span><span class="s2">&quot;col&quot;</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">names</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">date_cols</span> <span class="o">=</span> <span class="p">{</span><span class="n">f</span><span class="p">:</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="s1">&#39;%m_</span><span class="si">%d</span><span class="s1">_%y&#39;</span><span class="p">)</span> 
                          <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">names</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)}</span>
        
    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">get_rows</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">as_dict_iterable</span><span class="p">():</span>
                <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_cols</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">yield</span> <span class="n">res</span> <span class="o">+</span> <span class="p">[</span><span class="n">v</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">k</span><span class="p">])]</span>
        <span class="k">return</span> <span class="n">IterableDataFrame</span><span class="p">(</span><span class="n">get_rows</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_schema</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>In the above <code class="docutils literal notranslate"><span class="pre">Pivot</span></code> class, we consume the DataFrame and then use <code class="docutils literal notranslate"><span class="pre">as_dict_iterable</span></code> to process each row and turn it into long format. The output uses <code class="docutils literal notranslate"><span class="pre">IterableDataFrame</span></code> to minimize memory usage. If the DataFrame is large, not using an iterable requires the full DataFrame to unnecessarily be in memory.</p>
<p>Now, we can test this transformer locally on the default <code class="docutils literal notranslate"><span class="pre">NativeExecutionEngine</span></code>. Before transforming, we use a <code class="docutils literal notranslate"><span class="pre">SELECT</span> <span class="pre">LIMIT</span></code> to make the input data really small, so it can run quickly on native python. <strong>This is a very important to have this validation step</strong></p>
<ul class="simple">
<li><p>The limited data lets us focus on testing correctness, not scalability</p></li>
<li><p>Running on <code class="docutils literal notranslate"><span class="pre">NativeExecutionEngine</span></code> makes it extremely fast to find errors. More importantly, errors will be more explicit than running on a cluster where the stack trace is more complicated.</p></li>
<li><p>Consider using mock data as the input as well. Fugue SQL is very unit-testable and this can be added to unit tests (with mock input data)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">fsql</span>
LOAD CSV &quot;../../data/confirmed.csv&quot;(header=true)
SELECT * WHERE iso3 = &#39;USA&#39; LIMIT 10
confirmed = TRANSFORM USING Pivot(col=&quot;confirmed&quot;)
OUTPUT USING pprint
 
LOAD CSV &quot;../../data/death.csv&quot;(header=true)
SELECT * WHERE iso3 = &#39;USA&#39; LIMIT 10
death = TRANSFORM USING Pivot(col=&quot;death&quot;)
OUTPUT USING pprint
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>UID</th>
      <th>iso2</th>
      <th>iso3</th>
      <th>code3</th>
      <th>FIPS</th>
      <th>Admin2</th>
      <th>Province_State</th>
      <th>Country_Region</th>
      <th>Lat</th>
      <th>Long_</th>
      <th>Combined_Key</th>
      <th>date</th>
      <th>confirmed</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>84001001</td>
      <td>US</td>
      <td>USA</td>
      <td>840</td>
      <td>1001.0</td>
      <td>Autauga</td>
      <td>Alabama</td>
      <td>US</td>
      <td>32.53952745</td>
      <td>-86.64408227</td>
      <td>Autauga, Alabama, US</td>
      <td>2020-01-22</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>84001001</td>
      <td>US</td>
      <td>USA</td>
      <td>840</td>
      <td>1001.0</td>
      <td>Autauga</td>
      <td>Alabama</td>
      <td>US</td>
      <td>32.53952745</td>
      <td>-86.64408227</td>
      <td>Autauga, Alabama, US</td>
      <td>2020-01-23</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>84001001</td>
      <td>US</td>
      <td>USA</td>
      <td>840</td>
      <td>1001.0</td>
      <td>Autauga</td>
      <td>Alabama</td>
      <td>US</td>
      <td>32.53952745</td>
      <td>-86.64408227</td>
      <td>Autauga, Alabama, US</td>
      <td>2020-01-24</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>84001001</td>
      <td>US</td>
      <td>USA</td>
      <td>840</td>
      <td>1001.0</td>
      <td>Autauga</td>
      <td>Alabama</td>
      <td>US</td>
      <td>32.53952745</td>
      <td>-86.64408227</td>
      <td>Autauga, Alabama, US</td>
      <td>2020-01-25</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>84001001</td>
      <td>US</td>
      <td>USA</td>
      <td>840</td>
      <td>1001.0</td>
      <td>Autauga</td>
      <td>Alabama</td>
      <td>US</td>
      <td>32.53952745</td>
      <td>-86.64408227</td>
      <td>Autauga, Alabama, US</td>
      <td>2020-01-26</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>UID</th>
      <th>iso2</th>
      <th>iso3</th>
      <th>code3</th>
      <th>FIPS</th>
      <th>Admin2</th>
      <th>Province_State</th>
      <th>Country_Region</th>
      <th>Lat</th>
      <th>Long_</th>
      <th>Combined_Key</th>
      <th>Population</th>
      <th>date</th>
      <th>death</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>84001001</td>
      <td>US</td>
      <td>USA</td>
      <td>840</td>
      <td>1001.0</td>
      <td>Autauga</td>
      <td>Alabama</td>
      <td>US</td>
      <td>32.53952745</td>
      <td>-86.64408227</td>
      <td>Autauga, Alabama, US</td>
      <td>55869</td>
      <td>2020-01-22</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>84001001</td>
      <td>US</td>
      <td>USA</td>
      <td>840</td>
      <td>1001.0</td>
      <td>Autauga</td>
      <td>Alabama</td>
      <td>US</td>
      <td>32.53952745</td>
      <td>-86.64408227</td>
      <td>Autauga, Alabama, US</td>
      <td>55869</td>
      <td>2020-01-23</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>84001001</td>
      <td>US</td>
      <td>USA</td>
      <td>840</td>
      <td>1001.0</td>
      <td>Autauga</td>
      <td>Alabama</td>
      <td>US</td>
      <td>32.53952745</td>
      <td>-86.64408227</td>
      <td>Autauga, Alabama, US</td>
      <td>55869</td>
      <td>2020-01-24</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>84001001</td>
      <td>US</td>
      <td>USA</td>
      <td>840</td>
      <td>1001.0</td>
      <td>Autauga</td>
      <td>Alabama</td>
      <td>US</td>
      <td>32.53952745</td>
      <td>-86.64408227</td>
      <td>Autauga, Alabama, US</td>
      <td>55869</td>
      <td>2020-01-25</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>84001001</td>
      <td>US</td>
      <td>USA</td>
      <td>840</td>
      <td>1001.0</td>
      <td>Autauga</td>
      <td>Alabama</td>
      <td>US</td>
      <td>32.53952745</td>
      <td>-86.64408227</td>
      <td>Autauga, Alabama, US</td>
      <td>55869</td>
      <td>2020-01-26</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="bring-it-to-spark">
<h2>Bring it to Spark!<a class="headerlink" href="#bring-it-to-spark" title="Permalink to this headline">¶</a></h2>
<p>Now that we know the <code class="docutils literal notranslate"><span class="pre">Pivot</span></code> <code class="docutils literal notranslate"><span class="pre">Transformer</span></code> works fine, we can use <code class="docutils literal notranslate"><span class="pre">SparkExecutionEngine</span></code> to run it on Spark. To do this, we simply pass <code class="docutils literal notranslate"><span class="pre">spark</span></code> to <code class="docutils literal notranslate"><span class="pre">%%fsql</span></code>. In this section we will:</p>
<ol class="simple">
<li><p>Load the <code class="docutils literal notranslate"><span class="pre">confirmed.csv</span></code> and <code class="docutils literal notranslate"><span class="pre">death.csv</span></code></p></li>
<li><p>Pivot both of them after loading</p></li>
<li><p>Join them to use in later steps.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Persist</span></code> this DataFrame so it doesn’t get recomputed. <code class="docutils literal notranslate"><span class="pre">pprint</span></code> and <code class="docutils literal notranslate"><span class="pre">SAVE</span></code> will cause it to be computed twice.</p></li>
<li><p>Save it to persistent storage for quicker loading.</p></li>
</ol>
<p>Note that instead of adding <code class="docutils literal notranslate"><span class="pre">persist</span></code> explicitly, Fugue has an option to <a class="reference external" href="../advanced/useful_config.ipynb#Auto-Persist">auto-persist</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">fsql</span> spark
LOAD CSV &quot;../../data/confirmed.csv&quot;(header=true)
SELECT * WHERE iso3 = &#39;USA&#39;
confirmed = TRANSFORM USING Pivot(col=&quot;confirmed&quot;)
 
LOAD CSV &quot;../../data/death.csv&quot;(header=true)
SELECT * WHERE iso3 = &#39;USA&#39;
death = TRANSFORM USING Pivot(col=&quot;death&quot;)

SELECT 
    confirmed.Combined_Key AS key,
    confirmed.Admin2 AS city,
    confirmed.Province_State AS state,
    Population AS population,
    confirmed.date,
    confirmed.confirmed,
    death
FROM confirmed INNER JOIN death
    ON confirmed.Combined_Key = death.Combined_Key AND confirmed.date = death.date
PERSIST
    
OUTPUT USING pprint
SAVE OVERWRITE &quot;/tmp/covid19.parquet&quot;
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>key</th>
      <th>city</th>
      <th>state</th>
      <th>population</th>
      <th>date</th>
      <th>confirmed</th>
      <th>death</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Abbeville, South Carolina, US</td>
      <td>Abbeville</td>
      <td>South Carolina</td>
      <td>24527</td>
      <td>2020-03-15</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Adair, Kentucky, US</td>
      <td>Adair</td>
      <td>Kentucky</td>
      <td>19202</td>
      <td>2020-02-18</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Adair, Kentucky, US</td>
      <td>Adair</td>
      <td>Kentucky</td>
      <td>19202</td>
      <td>2020-06-04</td>
      <td>97</td>
      <td>19</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Adair, Missouri, US</td>
      <td>Adair</td>
      <td>Missouri</td>
      <td>25343</td>
      <td>2020-01-24</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Adair, Missouri, US</td>
      <td>Adair</td>
      <td>Missouri</td>
      <td>25343</td>
      <td>2020-04-20</td>
      <td>12</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The above DataFrame is persisted as a <code class="docutils literal notranslate"><span class="pre">parquet</span></code> because <code class="docutils literal notranslate"><span class="pre">parquet</span></code> files are compressed, often meaning 20% the size of equivalent <code class="docutils literal notranslate"><span class="pre">csv</span></code> files. This makes it significantly faster to load them than <code class="docutils literal notranslate"><span class="pre">csv</span></code> files. Spark also is optimized to read in <code class="docutils literal notranslate"><span class="pre">parquet</span></code> files so that data can intelligently be read in. We load the parquet back and do further data analysis using SQL, and output using <code class="docutils literal notranslate"><span class="pre">pprint</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">fsql</span> spark
data = LOAD &quot;/tmp/covid19.parquet&quot;

SELECT DISTINCT city, state, population FROM data
OUTPUT USING pprint

SELECT state, date, SUM(confirmed) AS confirmed, SUM(death) AS death
    FROM data GROUP BY state, date
OUTPUT USING pprint
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>city</th>
      <th>state</th>
      <th>population</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Dickens</td>
      <td>Texas</td>
      <td>2211</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Hudspeth</td>
      <td>Texas</td>
      <td>4886</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Jefferson</td>
      <td>Kentucky</td>
      <td>766757</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Mason</td>
      <td>Illinois</td>
      <td>13359</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Platte</td>
      <td>Nebraska</td>
      <td>33470</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>state</th>
      <th>date</th>
      <th>confirmed</th>
      <th>death</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Vermont</td>
      <td>2020-04-10</td>
      <td>679</td>
      <td>24</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Kansas</td>
      <td>2020-03-13</td>
      <td>6</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Pennsylvania</td>
      <td>2020-03-28</td>
      <td>2845</td>
      <td>34</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Colorado</td>
      <td>2020-04-14</td>
      <td>7950</td>
      <td>327</td>
    </tr>
    <tr>
      <th>4</th>
      <td>South Dakota</td>
      <td>2020-02-28</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="visualize-it">
<h2>Visualize it<a class="headerlink" href="#visualize-it" title="Permalink to this headline">¶</a></h2>
<p>It will be useful to see the confirmed vs death chart for different partitions. Partitions can be defined by city or state or something else. We want the exploration code to be flexible. For a given grouping, we want to plot the deaths and confirmed counts over time.</p>
<p>For a given partition, we will use a <code class="docutils literal notranslate"><span class="pre">transformer</span></code> to reshape the data, save a plot, and then return the file path to be loaded in later.</p>
<p>In the code below, <code class="docutils literal notranslate"><span class="pre">plotter</span></code> is a <code class="docutils literal notranslate"><span class="pre">transformer</span></code> that creates a seaborn plot and saves it. The location of that plot is then written in the resulting DataFrame under a column called <code class="docutils literal notranslate"><span class="pre">path</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">render_all</span></code> is a function that loads all of the images that were saved and displays them in this notebook.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">SVG</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="c1"># schema: key:str, path: str</span>
<span class="k">def</span> <span class="nf">plotter</span><span class="p">(</span><span class="n">df</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">key_col</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Transformer function to plot. Seaborn prefers long</span>
<span class="sd">    format for the data so that will be done inside here.</span>
<span class="sd">    This is agnostic to whatever partition is coming in.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># the input DataFrame is already partitioned</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">key_col</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">-plot.svg&quot;</span>\
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>\
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>

    <span class="c1"># reshaping to long format for seaborn</span>
    <span class="n">_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s2">&quot;date&quot;</span><span class="p">,</span><span class="s2">&quot;confirmed&quot;</span><span class="p">,</span><span class="s2">&quot;death&quot;</span><span class="p">]],</span> <span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;variable&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">_df</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Count&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Count Over Time for </span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;svg&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">title</span><span class="p">],</span> <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">file_path</span><span class="p">]})</span>

<span class="k">def</span> <span class="nf">render_all</span><span class="p">(</span><span class="n">df</span><span class="p">:</span><span class="n">Iterable</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="p">:</span>
        <span class="n">display</span><span class="p">(</span><span class="n">SVG</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
<p>Now let’s first test it using the <code class="docutils literal notranslate"><span class="pre">NativeExecutionEngine</span></code> on a small data set like before.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">fsql</span>
data = LOAD &quot;/tmp/covid19.parquet&quot;
SELECT * WHERE key = &#39;Adams, Mississippi, US&#39;
TRANSFORM PREPARTITION BY key PRESORT  date USING plotter(key_col=&quot;key&quot;)
OUTPUT USING render_all
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/example_covid19_18_0.svg" src="../../_images/example_covid19_18_0.svg" /></div>
</div>
<p>Noticed the partitioning statement that was used. <code class="docutils literal notranslate"><span class="pre">PREPARTITION</span> <span class="pre">BY</span></code> takes in a column to be used in creating the partitions. The partition can be on the city or state. These partitioned DataFrames are then independently passed to the <code class="docutils literal notranslate"><span class="pre">plotter</span></code> function, and the output is then collected after. Partitioning by state will run <code class="docutils literal notranslate"><span class="pre">plotter</span></code> once for each state.</p>
<p>The next thing to note is the <code class="docutils literal notranslate"><span class="pre">PRESORT</span></code>. Seaborn automatically sorts the x-value of the plot, but to be sure that the values are in chronological order, we can apply a <code class="docutils literal notranslate"><span class="pre">PRESORT</span></code> as the data is being partitioned so that it is already ordered by the time the <code class="docutils literal notranslate"><span class="pre">transformer</span></code> is applied.</p>
</div>
<div class="section" id="visualize-with-spark">
<h2>Visualize with Spark<a class="headerlink" href="#visualize-with-spark" title="Permalink to this headline">¶</a></h2>
<p>We only want to draw charts for the top 3 states with highest death numbers. In the following code, we will first find the top 3 states, then use <code class="docutils literal notranslate"><span class="pre">SEMI</span> <span class="pre">JOIN</span></code> to filter the dataset, and use the transformer to plot.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">fsql</span> spark
data = LOAD &quot;/tmp/covid19.parquet&quot;

top3 = 
    SELECT state, SUM(death) AS death 
    FROM data GROUP BY state 
    ORDER BY death DESC LIMIT 3 PERSIST

data = 
    SELECT * 
    FROM data 
    LEFT SEMI JOIN top3 
    ON data.state = top3.state
    WHERE date &gt; &#39;2020-04-01&#39;

agg = SELECT state, date, SUM(confirmed) AS confirmed, SUM(death) AS death
      FROM data
      GROUP BY state, date

-- this will use the last dataframe by default
TRANSFORM PREPARTITION BY state USING plotter(key_col=&quot;state&quot;)
OUTPUT USING render_all
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/example_covid19_22_0.svg" src="../../_images/example_covid19_22_0.svg" /><img alt="../../_images/example_covid19_22_1.svg" src="../../_images/example_covid19_22_1.svg" /><img alt="../../_images/example_covid19_22_2.svg" src="../../_images/example_covid19_22_2.svg" /></div>
</div>
</div>
<div class="section" id="productionizing">
<h2>Productionizing<a class="headerlink" href="#productionizing" title="Permalink to this headline">¶</a></h2>
<p>In order to bring this to production, all we have to do is pass the SQL code into the <code class="docutils literal notranslate"><span class="pre">fsql</span></code> function. To run this on Spark, pass the <code class="docutils literal notranslate"><span class="pre">SparkExecutionEngine</span></code> to the run method.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">fugue_sql</span> <span class="kn">import</span> <span class="n">fsql</span>
<span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">data = LOAD &quot;/tmp/covid19.parquet&quot;</span>

<span class="s2">top3 = </span>
<span class="s2">    SELECT state, SUM(death) AS death </span>
<span class="s2">    FROM data GROUP BY state </span>
<span class="s2">    ORDER BY death DESC LIMIT 3 PERSIST</span>
<span class="s2">    PRINT</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">fsql</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">SparkExecutionEngine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>state</th>
      <th>death</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>New York</td>
      <td>1690428</td>
    </tr>
    <tr>
      <th>1</th>
      <td>New Jersey</td>
      <td>558989</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Massachusetts</td>
      <td>301008</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output text_html"><small>schema: state:str,death:long</small></div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DataFrames()
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>In this example we have shown how FugueSQL can be used as the primary language for data analysis workflows. We were able to write our code by focusing on the partition level. When we were ready to apply it to a bigger dataset, all we had to do was specify the <code class="docutils literal notranslate"><span class="pre">SparkExecutionEngine</span></code>. Fugue allows users to specify the execution engine by changing one line of code.</p>
<p>FugueSQL is compatible with ANSI SQL, but it has enhancements that make it capable of describing computation workflows. Here we showed the variable assignment and additional keywords like <code class="docutils literal notranslate"><span class="pre">PERSIST</span></code>, <code class="docutils literal notranslate"><span class="pre">PREPARTITION</span></code> and <code class="docutils literal notranslate"><span class="pre">TRANSFORM</span></code> that allow FugueSQL to utilize Python functions and the Spark engine.</p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./tutorials/examples"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            



<div class='prev-next-bottom'>
    
    <div id="prev">
        <a class="left-prev" href="stock_sentiment.html" title="previous page">
            <i class="prevnext-label fas fa-angle-left"></i>
            <div class="prevnext-info">
                <p class="prevnext-label">previous</p>
                <p class="prevnext-title">Stock Sentiment Analysis (Preprocessing)</p>
            </div>
        </a>
    </div>
     <div id="next">
        <a class="right-next" href="../applications/index.html" title="next page">
            <div class="prevnext-info">
                <p class="prevnext-label">next</p>
                <p class="prevnext-title">Applications</p>
            </div>
            <i class="prevnext-label fas fa-angle-right"></i>
        </a>
     </div>

</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By The Jupyter Book community<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>